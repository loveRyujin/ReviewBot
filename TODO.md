# ReviewBot 项目改进计划

> 本文档包含对 ReviewBot 项目的全面分析以及后续改进的 TODO 列表

## 📊 项目概览

ReviewBot 是一个 AI 驱动的命令行工具，主要功能包括：
- 自动生成 commit message
- 代码审查（code review）
- 支持多种 AI Provider（OpenAI、DeepSeek、Gemini）
- 支持流式输出和多语言翻译

## ❗ 当前存在的问题

### 1. 代码架构问题
- ✅ Anthropic Provider 定义但未实现（`cmd/llm.go:31` 返回 nil）
- ❌ 全局配置变量 `globalConfig` 在 `cmd/root.go` 中，不够优雅，应该通过依赖注入
- ❌ `cmd` 包中文件过多（11 个文件），命令逻辑和业务逻辑耦合严重
- ❌ LLM client 创建逻辑散落在 `cmd/llm.go`，应该抽取到独立的 factory 包

### 2. 测试覆盖不足
- ✅ ~~测试文件仅 6 个，测试用例仅 15 个，覆盖率明显不足~~ → **已完成**: 19个测试文件，150+测试用例
- ✅ ~~缺少集成测试，特别是 AI Provider 的集成测试~~ → **已完成**: E2E 和集成测试框架已建立
- ⚠️ `cmd` 包中的命令逻辑测试覆盖较低（16.1%）→ 需要重构后进一步提升
- ✅ ~~缺少 mock 框架，外部依赖难以测试~~ → **已完成**: testify/mock 已引入

### 3. 错误处理
- ❌ 错误信息不够友好，缺少详细的上下文
- ❌ 没有统一的错误类型定义，难以区分错误类别
- ❌ 部分错误直接使用 `cobra.CheckErr`，不够优雅

### 4. 配置管理
- ✅ ~~配置验证逻辑较弱~~ → **已完成**: 完善的验证测试（85.5%覆盖率）
- ❌ 缺少配置迁移机制（版本升级时配置格式变更）
- ❌ 没有配置项的文档说明（需要生成配置文档）

### 5. 日志和可观测性
- ❌ 完全缺少结构化日志系统
- ❌ 没有调试模式（--debug flag）
- ❌ 缺少性能指标（API 调用耗时、token 使用统计）
- ❌ 没有错误追踪（error trace）

### 6. 用户体验
- ⚠️ commit 命令需要多次 AI 调用（3次），耗时较长
- ❌ 缺少交互式选择功能（如选择不同的 commit message 方案）
- ❌ review 命令输出格式单一，缺少 Markdown 格式化
- ❌ 没有历史记录功能（查看之前生成的 commit message）

### 7. 扩展性问题
- ❌ 新增 AI Provider 需要修改多处代码（违反开闭原则）
- ❌ prompt 模板缺少版本管理
- ❌ 缺少插件机制，无法扩展自定义命令

### 8. 性能优化
- ❌ commit 命令的 3 次 AI 调用可以考虑并发优化
- ❌ 大文件 diff 处理效率低，没有分块处理机制
- ❌ 缺少缓存机制（相同 diff 的结果缓存）

### 9. 文档和示例
- ⚠️ README 较完善，但缺少架构设计文档
- ❌ 缺少贡献指南（CONTRIBUTING.md）
- ❌ 缺少 API 文档（godoc 注释不完整）
- ❌ 缺少最佳实践和使用案例

### 10. CI/CD
- ✅ 有基础的 CI（golangci-lint）和发布流程
- ✅ ~~缺少自动化测试 workflow~~ → **已完成**: test.yml 已添加
- ✅ ~~缺少依赖更新检查（dependabot）~~ → **已完成**: dependabot.yml 已配置

---

## 📋 TODO List

### 🔴 高优先级（核心功能和质量）

#### 1. 完善测试体系
- [x] **T1.1**: 引入 mock 框架（如 `testify/mock` 或 `gomock`）
- [x] **T1.2**: 为 `cmd` 包添加单元测试，覆盖率目标 > 60%
- [x] **T1.3**: 为 `pkg/config` 添加完整的配置加载和验证测试
- [x] **T1.4**: 添加 AI Provider 的 mock 测试
- [x] **T1.5**: 建立 E2E 测试框架（使用真实 git repo）
- [x] **T1.6**: 添加 CI workflow 运行测试并生成覆盖率报告

#### 2. 实现 Anthropic Provider
- [ ] **T2.1**: 创建 `llm/anthropic` 包
- [ ] **T2.2**: 实现 `anthropic.Client` 和 `ChatCompletion` 方法
- [ ] **T2.3**: 实现 `StreamChatCompletion` 方法
- [ ] **T2.4**: 添加配置映射和初始化逻辑
- [ ] **T2.5**: 添加单元测试和文档

#### 3. 添加结构化日志系统
- [ ] **T3.1**: 引入日志库（推荐 `zap` 或 `slog`）
- [ ] **T3.2**: 添加 `--debug` 和 `--log-level` 全局参数
- [ ] **T3.3**: 在关键位置添加日志（AI 调用、配置加载、错误等）
- [ ] **T3.4**: 支持日志输出到文件
- [ ] **T3.5**: 添加请求追踪 ID（trace ID）

#### 4. 统一错误处理
- [ ] **T4.1**: 创建 `pkg/errors` 包，定义错误类型
- [ ] **T4.2**: 定义常见错误（ConfigError、APIError、GitError 等）
- [ ] **T4.3**: 重构代码使用统一的错误类型
- [ ] **T4.4**: 改进错误信息的用户友好性
- [ ] **T4.5**: 添加错误堆栈追踪功能

### 🟡 中优先级（体验优化和扩展性）

#### 5. 优化 commit 命令性能
- [ ] **T5.1**: 分析是否可以合并部分 AI 调用
- [ ] **T5.2**: 考虑并发调用非依赖的 AI 请求
- [ ] **T5.3**: 添加生成进度显示（1/3, 2/3, 3/3）
- [ ] **T5.4**: 添加缓存机制（基于 diff hash）
- [ ] **T5.5**: 支持快速模式（减少 AI 调用次数）

#### 6. 增强交互体验
- [ ] **T6.1**: commit 命令支持生成多个候选方案供用户选择
- [ ] **T6.2**: review 命令输出支持 Markdown 格式
- [ ] **T6.3**: 添加 `--format` 参数（json/markdown/plain）
- [ ] **T6.4**: 添加颜色主题配置
- [ ] **T6.5**: 支持交互式编辑生成的 commit message

#### 7. 添加历史记录功能
- [ ] **T7.1**: 创建 `pkg/history` 包
- [ ] **T7.2**: 实现历史记录存储（SQLite 或文件）
- [ ] **T7.3**: 添加 `reviewbot history` 命令查看历史
- [ ] **T7.4**: 支持重用历史记录的 commit message
- [ ] **T7.5**: 添加清理历史记录的功能

#### 8. 改进配置管理
- [x] **T8.1**: 完善配置验证逻辑（`pkg/config/validate.go`）
- [ ] **T8.2**: 添加配置迁移机制（version 字段）
- [ ] **T8.3**: 生成配置文档（自动从代码生成）
- [ ] **T8.4**: 添加 `reviewbot config validate` 命令
- [ ] **T8.5**: 支持环境特定配置（dev/prod profiles）

#### 9. 重构代码架构
- [ ] **T9.1**: 将 `cmd` 包拆分，业务逻辑移到 `pkg/service`
- [ ] **T9.2**: 创建 `pkg/factory` 包管理 AI client 创建
- [ ] **T9.3**: 使用依赖注入替代全局变量
- [ ] **T9.4**: 提取接口，降低耦合度
- [ ] **T9.5**: 重构超过 400 行的文件（如 `cmd/review.go`）

### 🟢 低优先级（增强功能）

#### 10. 添加更多 AI Provider
- [ ] **T10.1**: 支持 Azure OpenAI
- [ ] **T10.2**: 支持 Cohere
- [ ] **T10.3**: 支持 Hugging Face Inference API
- [ ] **T10.4**: 支持本地 LLM（Ollama）
- [ ] **T10.5**: 添加 Provider 性能对比文档

#### 11. 扩展 review 功能
- [ ] **T11.1**: 支持增量 review（只 review 变更的函数）
- [ ] **T11.2**: 支持安全漏洞扫描
- [ ] **T11.3**: 支持代码风格检查
- [ ] **T11.4**: 生成代码质量评分
- [ ] **T11.5**: 支持自定义 review 规则

#### 12. 添加插件系统
- [ ] **T12.1**: 设计插件接口规范
- [ ] **T12.2**: 实现插件加载机制
- [ ] **T12.3**: 提供插件开发文档和示例
- [ ] **T12.4**: 创建插件市场或仓库
- [ ] **T12.5**: 添加常用插件（如 PR 描述生成）

#### 13. 性能监控和分析
- [ ] **T13.1**: 添加 token 使用统计
- [ ] **T13.2**: 记录 API 调用耗时
- [ ] **T13.3**: 生成性能报告命令
- [ ] **T13.4**: 支持导出 metrics（Prometheus 格式）
- [ ] **T13.5**: 添加性能优化建议

#### 14. 完善文档
- [ ] **T14.1**: 编写架构设计文档（ARCHITECTURE.md）
- [ ] **T14.2**: 编写贡献指南（CONTRIBUTING.md）
- [ ] **T14.3**: 完善 godoc 注释
- [ ] **T14.4**: 添加更多使用示例和 gif 动图
- [ ] **T14.5**: 编写性能优化指南

#### 15. 增强 CI/CD
- [x] **T15.1**: 添加自动化测试 workflow
- [x] **T15.2**: 添加代码覆盖率徽章
- [x] **T15.3**: 配置 dependabot 自动更新依赖
- [ ] **T15.4**: 添加安全扫描（gosec）
- [ ] **T15.5**: 自动发布 Docker 镜像

#### 16. 新功能探索
- [ ] **T16.1**: 支持 PR 描述自动生成
- [ ] **T16.2**: 支持 issue 总结
- [ ] **T16.3**: 支持代码解释功能
- [ ] **T16.4**: 支持多仓库批量操作
- [ ] **T16.5**: 添加 Web UI（可选）

---

## 🎯 实施路线图

### Phase 1: 基础完善（1-2周）
**目标**：提升代码质量和可维护性  
**任务**：T1（测试）、T2（Anthropic）、T3（日志）、T4（错误处理）

**关键里程碑**：
- 测试覆盖率达到 60%+
- Anthropic Provider 可用
- 结构化日志系统运行
- 统一的错误处理机制

### Phase 2: 体验优化（2-3周）
**目标**：提升用户体验和性能  
**任务**：T5（性能）、T6（交互）、T8（配置）、T9（重构）

**关键里程碑**：
- commit 命令性能提升 30%+
- 支持多种输出格式
- 配置验证和迁移机制完善
- 代码架构更清晰

### Phase 3: 功能扩展（3-4周）
**目标**：增加核心功能  
**任务**：T7（历史）、T10（Provider）、T11（review 增强）

**关键里程碑**：
- 历史记录功能可用
- 支持 3+ 个新 AI Provider
- review 功能显著增强

### Phase 4: 生态建设（持续）
**目标**：建立完善的开发者生态  
**任务**：T12（插件）、T13（监控）、T14（文档）、T15（CI/CD）、T16（新功能）

**关键里程碑**：
- 插件系统上线
- 完善的文档体系
- 强大的 CI/CD 流程
- 活跃的社区贡献

---

## 💡 实施原则

### 1. 测试先行
在重构或添加新功能前，先编写测试用例，确保改动不会引入回归问题。

### 2. 小步快跑
- 每个 TODO 项完成后及时提交
- 遵循 Conventional Commits 规范（`feat:`, `fix:`, `refactor:`, `test:`, `docs:`）
- 保持每次提交的改动在合理范围内

### 3. 开闭原则
- 新增功能优先通过扩展实现，而非修改现有代码
- 使用接口和抽象降低耦合
- 考虑向后兼容性

### 4. 及时重构
- 发现代码异味立即重构
- 删除冗余代码
- 保持代码简洁清晰

### 5. 文档同步
- 代码改动时同步更新文档
- 保持 README、AGENTS.md 和代码注释的一致性
- 重要功能提供使用示例

### 6. 性能基准
- 优化前建立性能基线
- 优化后进行对比验证
- 避免过度优化

---

## 📈 进度追踪

### 已完成
- ✅ 项目分析完成
- ✅ TODO 列表生成
- ✅ 实施路线图制定
- ✅ 测试体系基础建设

### 进行中
- 🔄 待开始实施

### 下一步
1. 选择 Phase 1 中的第一个任务开始实施
2. 建立测试框架
3. 完善 CI/CD 流程

---

## 📞 反馈与讨论

如有任何建议或问题，欢迎通过以下方式反馈：
- 在 GitHub Issues 中创建讨论
- 在相关 PR 中评论
- 联系项目维护者

